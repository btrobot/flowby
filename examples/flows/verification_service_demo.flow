# Verification Service API Demo - DSL v2.0
#
# 演示如何使用 DSL 调用微服务 API
# 实现账号创建、验证码查询和账号更新的完整流程
#
# 微服务地址: http://8.138.175.157:8888
# API 文档参考: F:\ms\vs\verification-service-microservices\examples\api_usage_examples.py
#
# 使用方法:
#   python run_dsl.py flows/verification_service_demo.flow
#
# 功能演示:
#   1. 创建邮箱账号 (POST /api/account/internal/accounts)
#   2. 查询验证码 (GET /api/account/internal/accounts/{email})
#   3. 手动设置验证码 (POST /api/account/internal/accounts/{email}/verification-code)
#   4. 更新账号状态 (POST /api/account/internal/accounts/{email}/mark-registered)
#   5. 查询账号详情 (GET /api/account/internal/accounts/{email})

# ============================================================
# 配置常量
# ============================================================

const BASE_URL = "http://8.138.175.157:8888"
const API_PREFIX = "/api/account/internal/accounts"

# 超时和重试配置
const REQUEST_TIMEOUT = 30
const POLL_INTERVAL = 5
const MAX_POLL_ATTEMPTS = 6

# 声明全局变量（将在各步骤中赋值）
let success = false
let email = ""
let password = ""
let account_id = 0
let account_status = ""
let verification_code = ""

# ============================================================
# Step 1: 创建邮箱账号
# ============================================================

step "创建邮箱账号"
    log "=========================================="
    log "示例 1: 创建邮箱账号"
    log "=========================================="

    log "正在创建新的邮箱账号..."

    # 调用创建账号 API
    # POST /api/account/internal/accounts
    call "http.post" with url=BASE_URL + API_PREFIX, json={email_format: "realistic"} into account_response

    # 检查响应状态
    let status_code = account_response.status_code
    success = status_code == 200 or status_code == 201

    if success:
        # 提取账号信息
        let account_data = account_response.data
        email = account_data.email
        password = account_data.password
        account_status = account_data.status
        account_id = account_data.id

        log "[OK] 账号创建成功!"
        log ""
        log "账号信息:"
        log "  ID: {account_id}"
        log "  邮箱: {email}"
        log "  密码: {password}"
        log "  状态: {account_status}"
        log ""
    else:
        log "[FAIL] 账号创建失败"
        log "  状态码: {status_code}"
        log "  错误: {account_response.error}"
    end if
end step

# ============================================================
# Step 2: 查询验证码（轮询）
# ============================================================

step "查询验证码"
    log "=========================================="
    log "示例 2: 查询验证码"
    log "=========================================="

    if not success:
        log "[SKIP] 跳过此步骤 - 账号创建失败"
    end if

    if success:
        log "正在查询账号的验证码..."
        log "账号: {email}"
        log ""

        # 构建查询 URL
        let query_url = BASE_URL + API_PREFIX + "/" + email

        # 首次查询
        log "子示例 2.1: 查询当前存储的验证码"
        call "http.get" with url=query_url into code_response

        let code_ok = code_response.ok

        if code_ok:
            let code_data = code_response.data
            let code_value = code_data.verification_code

            if code_value:
                verification_code = code_value
                log "[OK] 验证码已存在: {verification_code}"
            else:
                log "[INFO] 验证码尚未到达"
            end if
        else:
            log "[FAIL] 查询失败: {code_response.error}"
        end if

        log ""
        log "----------------------------------------"
        log ""

        # 轮询等待验证码
        log "子示例 2.2: 轮询等待验证码到达"
        log "  每 {POLL_INTERVAL} 秒查询一次，最多 {MAX_POLL_ATTEMPTS} 次"
        log ""

        let attempt = 0
        let code_found = false

        # 循环轮询
        for i in [1, 2, 3, 4, 5, 6]:
            if not code_found:
                attempt = attempt + 1
                log "  第 {attempt}/{MAX_POLL_ATTEMPTS} 次查询..."

                call "http.get" with url=query_url into poll_response

                if poll_response.ok:
                    let poll_data = poll_response.data
                    let poll_code = poll_data.verification_code

                    if poll_code:
                        verification_code = poll_code
                        code_found = true
                        log "  [OK] 验证码已到达: {verification_code}"
                        log ""
                    else:
                        log "  [WAIT] 验证码还未到达，等待中..."
                        wait 5s
                    end if
                else:
                    log "  [FAIL] 查询失败: {poll_response.error}"
                end if
            end if
        end for

        if not code_found:
            log "  [TIMEOUT] 验证码未在预期时间内到达"
            log ""
        end if
    end if
end step

# ============================================================
# Step 3: 手动设置验证码（用于演示）
# ============================================================

step "手动设置验证码"
    log "=========================================="
    log "示例 3: 手动设置验证码"
    log "=========================================="

    if not success:
        log "[SKIP] 跳过此步骤 - 账号创建失败"
    end if

    if success:
        log "子示例 2.3: 手动设置验证码（实际场景中会由 Code Receiver 自动完成）"
        log ""

        # 设置一个测试验证码
        const TEST_CODE = "123456"
        log "  设置验证码: {TEST_CODE}"

        # 构建设置验证码的 URL
        let set_code_url = BASE_URL + API_PREFIX + "/" + email + "/verification-code"

        # 调用设置验证码 API
        call "http.post" with url=set_code_url, json={verification_code: TEST_CODE} into set_code_response

        let set_code_ok = set_code_response.ok

        if set_code_ok:
            let set_code_data = set_code_response.data
            verification_code = set_code_data.verification_code
            let updated_status = set_code_data.status
            let wait_time = set_code_data.wait_time_seconds

            log ""
            log "[OK] 验证码设置成功!"
            log "  验证码: {verification_code}"
            log "  账号状态: {updated_status}"

            if wait_time:
                log "  等待时间: {wait_time} 秒"
            end if
        else:
            log "[FAIL] 设置验证码失败: {set_code_response.error}"
        end if

        log ""
    end if
end step

# ============================================================
# Step 4: 更新账号状态（标记为已注册）
# ============================================================

step "更新账号状态"
    log "=========================================="
    log "示例 4: 更新账号信息"
    log "=========================================="

    if not success:
        log "[SKIP] 跳过此步骤 - 账号创建失败"
    end if

    if success:
        log "子示例 3.1: 标记账号为已注册"
        log "  将 {email} 标记为已注册状态"
        log ""

        # 构建标记注册的 URL
        let mark_registered_url = BASE_URL + API_PREFIX + "/" + email + "/mark-registered"

        # 调用标记已注册 API
        call "http.post" with url=mark_registered_url into register_response

        let register_ok = register_response.ok

        if register_ok:
            let register_data = register_response.data
            let final_status = register_data.status
            let registered_at = register_data.registered_at

            log "[OK] 账号已标记为已注册"
            log "  账号状态: {final_status}"

            if registered_at:
                log "  注册时间: {registered_at}"
            end if
        else:
            log "[FAIL] 标记失败: {register_response.error}"
        end if

        log ""
    end if
end step

# ============================================================
# Step 5: 查询账号最终状态
# ============================================================

step "查询账号最终状态"
    log "=========================================="
    log "示例 5: 查询账号最终状态"
    log "=========================================="

    if not success:
        log "[SKIP] 跳过此步骤 - 账号创建失败"
    end if

    if success:
        log "子示例 3.2: 查询账号完整信息"
        log ""

        # 构建查询 URL
        let final_query_url = BASE_URL + API_PREFIX + "/" + email

        # 查询账号详情
        call "http.get" with url=final_query_url into final_response

        let final_ok = final_response.ok

        if final_ok:
            let final_data = final_response.data

            log "[OK] 账号信息:"
            log ""
            log "  ID: {final_data.id}"
            log "  邮箱: {final_data.email}"
            log "  密码: {final_data.password}"
            log "  状态: {final_data.status}"
            log "  验证码: {final_data.verification_code}"
            log ""
            log "账号生命周期:"
            log "  创建时间: {final_data.created_at}"

            let has_code_time = final_data.code_received_at
            if has_code_time:
                log "  收到验证码: {final_data.code_received_at}"
            end if

            let has_verify_time = final_data.verified_at
            if has_verify_time:
                log "  验证完成: {final_data.verified_at}"
            end if

            let has_register_time = final_data.registered_at
            if has_register_time:
                log "  完成注册: {final_data.registered_at}"
            end if
        else:
            log "[FAIL] 查询失败: {final_response.error}"
        end if
    end if
end step

# ============================================================
# 总结
# ============================================================

step "总结"
    log ""
    log "=========================================="
    log "流程完成"
    log "=========================================="

    if success:
        log ""
        log "最终账号信息:"
        log "  邮箱地址: {email}"
        log "  登录密码: {password}"
        log "  验证码: {verification_code}"
        log "  API 地址: {BASE_URL}{API_PREFIX}"
        log ""
        log "[SUCCESS] 所有步骤执行成功!"
    else:
        log ""
        log "[FAIL] 流程执行失败，请检查错误信息"
    end if

    log "=========================================="
end step
