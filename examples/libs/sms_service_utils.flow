# ============================================================
# 5sim SMS 服务工具库 v1.1
# ============================================================
#
# 用途：封装 5sim 服务的高级操作，提供简洁的接口
#
# 核心功能（实际使用流程）：
#   1. buy_phone_number: 购买号码
#   2. wait_for_verification_code: 等待验证码（轮询）
#   3. cleanup_order: 清理订单（完成或取消）
#
# 辅助功能：
#   - check_balance: 检查余额
#   - query_price: 查询价格
#
# 实际使用流程：
#   ```flow
#   # 1. 购买号码
#   let buy_result = buy_phone_number(fivesim, "england", "virtual60", "factoryai")
#
#   # 2. 在网页输入号码
#   type buy_result.phone
#   click  # 提交，页面跳转
#
#   # 3. 等待验证码
#   let code_result = wait_for_verification_code(fivesim, buy_result.order_id, 5)
#
#   # 4. 输入验证码
#   type code_result.code
#
#   # 5. 完成订单
#   cleanup_order(fivesim, buy_result.order_id, True)
#   ```
#
# 版本：v1.1
# 更新：2025-11-29 - 拆分 buy 和 wait，支持中间插入网页操作
#
# ============================================================

library sms_service_utils

# ============================================================
# 核心函数（按使用顺序）
# ============================================================

export function buy_phone_number(fivesim_resource, country, operator, product):
    """
    购买临时手机号码

    参数：
        fivesim_resource: 5sim 资源对象（通过 resource 语句创建）
        country: 国家名称（如 "england"）
        operator: 运营商名称（如 "virtual60"）
        product: 服务名称（如 "factoryai"）

    返回：
        {
            "success": True/False,
            "phone": "+447868211483",      # 完整手机号（国际格式）
            "phone_local": "7868211483",   # 本地号码（去掉国家码）
            "country_code": "+44",         # 国家码
            "order_id": 914134218,         # 订单 ID（后续查询验证码需要）
            "price": 7.0,
            "status": "PENDING",
            "message": "成功/失败原因"
        }
    """

    log info "=== 购买临时手机号码 ==="
    log info "  国家: {country}"
    log info "  运营商: {operator}"
    log info "  服务: {product}"

    # buyNumber 使用路径参数，直接传递参数值
    let buy_response = fivesim_resource.buyNumber(country, operator, product)

    let order_id = buy_response.id
    let phone = buy_response.phone
    let price = buy_response.price
    let status = buy_response.status

    # 解析号码（提取国家码和本地号码）
    # 5sim API 返回格式: +<国家码><本地号码>
    # 示例：+447868211483, +15551234567
    let country_code = ""
    let country_code_len = 0

    # 根据国家提取国家码长度
    if country == "england":
        country_code = "+44"
        country_code_len = 3  # "+44" 长度
    else:
        if country == "usa":
            country_code = "+1"
            country_code_len = 2  # "+1" 长度
        else:
            # 其他国家：使用默认提取逻辑（假设国家码为 2-3 位）
            # 暂时使用 "+1" 作为默认
            country_code = "+"
            country_code_len = 1

    # 使用 substring() 函数提取本地号码（Python 风格，去掉国家码前缀）
    let phone_local = substring(phone, country_code_len)

    log success "  号码购买成功!"
    log success "  完整号码: {phone}"
    log success "  国家码: {country_code}"
    log success "  本地号码: {phone_local}"
    log success "  订单 ID: {order_id}"
    log success "  价格: ${price}"
    log ""

    return {
        "success": True,
        "phone": phone,
        "phone_local": phone_local,
        "country_code": country_code,
        "order_id": order_id,
        "price": price,
        "status": status,
        "message": "号码购买成功"
    }


export function poll_for_verification_code(fivesim_resource, order_id, max_seconds, interval_seconds):
    """
    轮询查询验证码

    参数：
        fivesim_resource: 5sim 资源对象
        order_id: 订单 ID
        max_seconds: 最大等待秒数（如 300 = 5 分钟）
        interval_seconds: 轮询间隔秒数（如 5）

    返回：
        {
            "success": True/False,
            "code": "123456",
            "status": "RECEIVED",
            "message": "成功/失败原因"
        }
    """

    let max_attempts = max_seconds / interval_seconds
    let attempt = 0

    log info "  开始轮询（最多 {max_attempts} 次，间隔 {interval_seconds} 秒）"

    while attempt < max_attempts:
        # 等待间隔
        wait 5 s  # interval_seconds（DSL 限制：必须用字面量）

        attempt = attempt + 1

        # 查询订单状态（checkOrder 使用路径参数）
        let check_response = fivesim_resource.checkOrder(order_id)

        let status = check_response.status
        let sms_list = check_response.sms

        log info "    [尝试 {attempt}/{max_attempts}] 状态: {status}"

        # 检查是否收到短信
        if status == "RECEIVED" or status == "FINISHED":
            if len(sms_list) > 0:
                # 取最后一条短信（最新的验证码）
                let last_index = len(sms_list) - 1
                let latest_sms = sms_list[last_index]
                let code = latest_sms.code

                return {
                    "success": True,
                    "code": code,
                    "sms_text": latest_sms.text,
                    "sender": latest_sms.sender,
                    "status": status,
                    "message": "成功接收验证码"
                }

        # 检查订单是否异常结束
        if status == "CANCELED" or status == "TIMEOUT" or status == "BANNED":
            return {
                "success": False,
                "status": status,
                "message": "订单异常结束: {status}"
            }

        # 继续下一次轮询

    # 超时未收到验证码
    return {
        "success": False,
        "status": "TIMEOUT",
        "message": "轮询超时（{max_attempts} 次，{max_seconds} 秒）"
    }


export function wait_for_verification_code(fivesim_resource, order_id, max_wait_minutes):
    """
    等待接收短信验证码（轮询）

    使用场景：
        在网页上输入号码并提交后，调用此函数等待验证码

    参数：
        fivesim_resource: 5sim 资源对象
        order_id: 订单 ID（buy_phone_number 返回的 order_id）
        max_wait_minutes: 最大等待时间（分钟，建议 5-10）

    返回：
        {
            "success": True/False,
            "code": "123456",              # 验证码
            "sms_text": "Your code is...", # 完整短信内容
            "sender": "FactoryAI",         # 发送者
            "status": "RECEIVED",
            "message": "成功/失败原因"
        }
    """

    log info "=== 等待短信验证码 ==="
    log info "  订单 ID: {order_id}"
    log info "  最大等待: {max_wait_minutes} 分钟"
    log ""

    # 轮询查询验证码
    # 参数：资源对象，订单ID，最大等待秒数，轮询间隔秒数
    let poll_result = poll_for_verification_code(
        fivesim_resource,
        order_id,
        max_wait_minutes * 60,
        5
    )

    if poll_result.success:
        log success "  验证码接收成功: {poll_result.code}"
        log ""
    else:
        log error "  验证码接收失败: {poll_result.message}"
        log ""

    return poll_result

export function cleanup_order(fivesim_resource, order_id, is_success):
    """
    清理订单（完成或取消）

    参数：
        fivesim_resource: 5sim 资源对象
        order_id: 订单 ID
        is_success: 是否成功（True=完成订单，False=取消订单）

    返回：
        {
            "success": True/False,
            "status": "FINISHED/CANCELED",
            "message": "成功/失败原因"
        }
    """

    if is_success:
        log info "[3/3] 完成订单..."

        # finishOrder 使用路径参数
        let finish_response = fivesim_resource.finishOrder(order_id)

        log success "  订单已完成"
        return {
            "success": True,
            "status": finish_response.status,
            "message": "订单完成"
        }

    else:
        log warning "[3/3] 取消订单..."

        # cancelOrder 使用路径参数
        let cancel_response = fivesim_resource.cancelOrder(order_id)

        log warning "  订单已取消"
        return {
            "success": True,
            "status": cancel_response.status,
            "message": "订单取消"
        }


export function check_balance(fivesim_resource, min_balance):
    """
    检查账户余额是否充足

    参数：
        fivesim_resource: 5sim 资源对象
        min_balance: 最低余额要求（美元）

    返回：
        {
            "success": True/False,
            "balance": 143.25,
            "email": "user@example.com",
            "rating": 96,
            "message": "成功/失败原因"
        }
    """

    log info "检查账户余额..."

    let balance_response = fivesim_resource.getBalance()

    let balance = balance_response.balance
    let email = balance_response.email
    let rating = balance_response.rating

    log success "  账户: {email}"
    log success "  余额: ${balance}"
    log success "  评分: {rating}"

    if balance < min_balance:
        log error "  余额不足！需要至少 ${min_balance}"
        return {
            "success": False,
            "balance": balance,
            "email": email,
            "rating": rating,
            "message": "余额不足"
        }

    return {
        "success": True,
        "balance": balance,
        "email": email,
        "rating": rating,
        "message": "余额充足"
    }


export function query_price(fivesim_resource, country, product, operator):
    """
    查询指定号码的价格和可用性

    参数：
        fivesim_resource: 5sim 资源对象
        country: 国家名称
        product: 服务名称
        operator: 运营商名称

    返回：
        {
            "success": True/False,
            "cost": 7.0,
            "count": 1000,
            "rate": 95.6,
            "message": "成功/失败原因"
        }
    """

    log info "查询号码价格..."
    log info "  国家: {country}"
    log info "  服务: {product}"
    log info "  运营商: {operator}"

    let prices_response = fivesim_resource.getPrices({
        "country": country,
        "product": product
    })

    # 导航到具体价格：country -> product -> operator
    let country_prices = prices_response[country]
    let product_prices = country_prices[product]
    let operator_price = product_prices[operator]

    let cost = operator_price.cost
    let count = operator_price.count
    let rate = operator_price.rate

    log success "  价格: ${cost}"
    log success "  可用数量: {count}"
    log success "  成功率: {rate}%"

    if count < 1:
        return {
            "success": False,
            "cost": cost,
            "count": count,
            "rate": rate,
            "message": "没有可用号码"
        }

    return {
        "success": True,
        "cost": cost,
        "count": count,
        "rate": rate,
        "message": "查询成功"
    }


# ============================================================
# 库元数据
# ============================================================
# 导出函数总数: 5
# 分类: 高级操作(1) + 核心操作(2) + 辅助操作(2)
# 复用性: ⭐⭐⭐⭐⭐ 5sim 服务通用封装
# 依赖: 需要通过 resource 语句创建的 fivesim 资源对象
# ============================================================
