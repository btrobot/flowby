# ============================================================
# è‡ªåŠ¨åŒ–æµ‹è¯•é€šç”¨å·¥å…·åº“ v1.0
# ============================================================
#
# ç”¨é€”ï¼šæä¾›è‡ªåŠ¨åŒ–æµ‹è¯•æµç¨‹ä¸­å¸¸ç”¨çš„å·¥å…·å‡½æ•°
#
# åŠŸèƒ½æ¨¡å—ï¼š
#   - æ—¥å¿—å·¥å…·ï¼šç»Ÿä¸€æ—¥å¿—æ ¼å¼
#   - æµç¨‹æ§åˆ¶ï¼šä¸­æ­¢æµç¨‹ã€éªŒè¯æ–­è¨€
#   - éªŒè¯å·¥å…·ï¼šé‚®ç®±ã€URLæ ¼å¼éªŒè¯
#   - æˆªå›¾å·¥å…·ï¼šæˆªå›¾ + è‡ªåŠ¨æ—¥å¿—
#   - è¡¨å•æ“ä½œï¼šå¡«å†™å­—æ®µã€ç­‰å¾…ç¨³å®š
#   - URLå·¥å…·ï¼šè·å–URLã€æ£€æŸ¥å˜åŒ–
#
# ä½¿ç”¨æ–¹å¼ï¼š
#   import automation_utils from "../libs/automation_utils.flow"
#   automation_utils.take_screenshot("page_loaded")
#
# æˆ–ï¼š
#   from "../libs/automation_utils.flow" import take_screenshot
#   take_screenshot("page_loaded")
#
# ç‰ˆæœ¬ï¼šv1.0
# ä½œè€…ï¼šRegistration System Team
# æ—¥æœŸï¼š2025-11-29
#

library automation_utils

# ============================================================
# æ—¥å¿—å·¥å…·å‡½æ•°
# ============================================================

export function log_phase_start(phase_num, phase_name, progress_total):
    """
    è®°å½•é˜¶æ®µå¼€å§‹

    Args:
        phase_num: å½“å‰é˜¶æ®µç¼–å·
        phase_name: é˜¶æ®µåç§°
        progress_total: æ€»é˜¶æ®µæ•°

    Example:
        log_phase_start(1, "è´¦å·å‡†å¤‡", 4)
        # è¾“å‡º: é˜¶æ®µ [1/4]: è´¦å·å‡†å¤‡
    """
    log "é˜¶æ®µ [{phase_num}/{progress_total}]: {phase_name}"
    log ""

export function log_subtask(task_id, task_name):
    """
    è®°å½•å­ä»»åŠ¡å¼€å§‹

    Args:
        task_id: å­ä»»åŠ¡ç¼–å·ï¼ˆå¦‚ "1.1"ï¼‰
        task_name: å­ä»»åŠ¡åç§°

    Example:
        log_subtask("1.1", "åˆ›å»ºä¸´æ—¶é‚®ç®±")
        # è¾“å‡º: [1.1] åˆ›å»ºä¸´æ—¶é‚®ç®±
    """
    log "[{task_id}] {task_name}"

# ============================================================
# æµç¨‹æ§åˆ¶å‡½æ•°
# ============================================================

export function abort_workflow(reason):
    """
    ä¸­æ­¢æµç¨‹å¹¶è®°å½•åŸå› 

    æ³¨æ„ï¼šç”±äº exit è¯­å¥çš„é™åˆ¶ï¼Œå…ˆè®°å½•é”™è¯¯æ—¥å¿—ï¼Œç„¶åé€šè¿‡ exit 1 ä¸­æ­¢æµç¨‹

    Args:
        reason: ä¸­æ­¢åŸå› 

    Example:
        abort_workflow("é‚®ç®±åˆ›å»ºå¤±è´¥ï¼ˆå·²é‡è¯•3æ¬¡ï¼‰")
    """
    log error "      [è‡´å‘½é”™è¯¯] {reason}"
    log error "      æµç¨‹å°†ä¸­æ­¢"
    exit 1

export function validate_and_assert(condition, success_msg, error_msg):
    """
    éªŒè¯æ¡ä»¶å¹¶ assertï¼ˆå¤±è´¥ä¼šè‡ªåŠ¨ä¸­æ­¢æµç¨‹ï¼‰

    Args:
        condition: éªŒè¯æ¡ä»¶ï¼ˆTrue/Falseï¼‰
        success_msg: æˆåŠŸæ—¶çš„æ—¥å¿—æ¶ˆæ¯
        error_msg: å¤±è´¥æ—¶çš„é”™è¯¯æ¶ˆæ¯ï¼ˆassert messageï¼‰

    Returns:
        Trueï¼ˆæ¡ä»¶é€šè¿‡æ—¶ï¼‰

    Example:
        validate_and_assert(
            email contains "@",
            "é‚®ç®±æ ¼å¼éªŒè¯é€šè¿‡",
            "Invalid email format"
        )
    """
    assert condition, error_msg
    log success "      Assert é€šè¿‡: {success_msg}"
    return True

# ============================================================
# éªŒè¯å·¥å…·å‡½æ•°
# ============================================================

export function validate_email_format(email):
    """
    éªŒè¯é‚®ç®±æ ¼å¼ï¼ˆç®€å•æ£€æŸ¥ï¼‰

    Args:
        email: é‚®ç®±åœ°å€å­—ç¬¦ä¸²

    Returns:
        True: åŒ…å« @ ç¬¦å·
        False: ä¸åŒ…å« @ ç¬¦å·

    Example:
        if validate_email_format("test@example.com"):
            log "é‚®ç®±æ ¼å¼æ­£ç¡®"
    """
    return email contains "@"

export function validate_url_domain(url, expected_domain):
    """
    éªŒè¯ URL åŒ…å«æœŸæœ›çš„åŸŸå

    Args:
        url: å®Œæ•´URLå­—ç¬¦ä¸²
        expected_domain: æœŸæœ›çš„åŸŸåï¼ˆå¦‚ "example.com"ï¼‰

    Returns:
        True: URLåŒ…å«æœŸæœ›åŸŸå
        False: URLä¸åŒ…å«æœŸæœ›åŸŸå

    Example:
        if validate_url_domain(page.url, "factory.ai"):
            log "åŸŸåéªŒè¯é€šè¿‡"
    """
    return url contains expected_domain

# ============================================================
# æˆªå›¾å·¥å…·å‡½æ•°
# ============================================================

export function take_screenshot(name):
    """
    æˆªå›¾å¹¶è‡ªåŠ¨è®°å½•æ—¥å¿—

    Args:
        name: æˆªå›¾æ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åï¼‰

    Example:
        take_screenshot("page_loaded")
        # æ‰§è¡Œ: screenshot as "page_loaded"
        # æ—¥å¿—: ğŸ“¸ æˆªå›¾: page_loaded.png
    """
    screenshot as name
    log "      ğŸ“¸ æˆªå›¾: {name}.png"

export function take_fullpage_screenshot(name):
    """
    å…¨å±æˆªå›¾å¹¶è‡ªåŠ¨è®°å½•æ—¥å¿—

    Args:
        name: æˆªå›¾æ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åï¼‰

    Example:
        take_fullpage_screenshot("full_page")
        # æ‰§è¡Œ: screenshot fullpage as "full_page"
        # æ—¥å¿—: ğŸ“¸ å…¨å±æˆªå›¾: full_page.png
    """
    screenshot fullpage as name
    log "      ğŸ“¸ å…¨å±æˆªå›¾: {name}.png"

# ============================================================
# è¡¨å•æ“ä½œå‡½æ•°
# ============================================================

export function fill_form_field(xpath, value, field_name):
    """
    å¡«å†™è¡¨å•å­—æ®µï¼šé€‰æ‹© + è¾“å…¥ + ç­‰å¾… + æ—¥å¿—

    Args:
        xpath: å­—æ®µçš„ XPath å®šä½å™¨
        value: è¦è¾“å…¥çš„å€¼
        field_name: å­—æ®µåç§°ï¼ˆç”¨äºæ—¥å¿—ï¼‰

    Example:
        fill_form_field(
            "//input[@id='email']",
            "test@example.com",
            "Email"
        )
        # è¾“å‡ºæ—¥å¿—: Email: test@example.com
    """
    log info "      {field_name}: {value}"
    select input where xpath=xpath
    type value
    wait 500 ms

export function settle_page():
    """
    ç­‰å¾…é¡µé¢ç¨³å®šï¼ˆç½‘ç»œç©ºé—² + å›ºå®šç­‰å¾…ï¼‰

    Example:
        settle_page()
        # ç­‰å¾…ç½‘ç»œç©ºé—² + 3ç§’å›ºå®šç­‰å¾…
    """
    wait for networkidle
    wait 3 s

# ============================================================
# URL å·¥å…·å‡½æ•°
# ============================================================

export function get_and_log_current_url(label):
    """
    è·å–å½“å‰ URL å¹¶è®°å½•æ—¥å¿—

    Args:
        label: æ—¥å¿—æ ‡ç­¾ï¼ˆæè¿°æ­¤URLçš„ç”¨é€”ï¼‰

    Returns:
        å½“å‰é¡µé¢URLå­—ç¬¦ä¸²

    Example:
        let url = get_and_log_current_url("æäº¤å‰URL")
        # æ—¥å¿—: æäº¤å‰URL: https://example.com/page
    """
    let url = page.url
    log info "      {label}: {url}"
    return url

export function check_url_change(url_before, url_after):
    """
    æ£€æŸ¥ URL æ˜¯å¦å˜åŒ–

    Args:
        url_before: å˜åŒ–å‰çš„URL
        url_after: å˜åŒ–åçš„URL

    Returns:
        True: URLå·²å˜åŒ–
        False: URLæœªå˜åŒ–

    Example:
        let changed = check_url_change(old_url, new_url)
        if changed:
            log "é¡µé¢å·²è·³è½¬"
    """
    if url_after != url_before:
        log success "      URL å·²å˜åŒ–"
        return True
    else:
        log warning "      URL æœªå˜åŒ–ï¼Œå¯èƒ½éœ€è¦äººå·¥æ£€æŸ¥"
        return False

# ============================================================
# åº“å…ƒæ•°æ®
# ============================================================
# å¯¼å‡ºå‡½æ•°æ€»æ•°: 12
# åˆ†ç±»: æ—¥å¿—(2) + æµç¨‹æ§åˆ¶(2) + éªŒè¯(2) + æˆªå›¾(2) + è¡¨å•(2) + URL(2)
# å¤ç”¨æ€§: â­â­â­â­â­ é«˜åº¦å¯å¤ç”¨
# ä¾èµ–: æ— å¤–éƒ¨ä¾èµ–ï¼Œåªä¾èµ–DSLå†…ç½®åŠŸèƒ½
# ============================================================
